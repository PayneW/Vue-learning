<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VueåŒå‘æ•°æ®ç»‘å®šåŸç†</title>
    <style type="text/css">
        * {margin:0; padding:0;list-style:none;font-size:14px; border:0; }
        .container {
            width:600px; height:400px;
            background: lightcoral;
            padding:20px; margin:100px auto;
        }
        p {
            border-radius: 6px;
            line-height: 40px; width: 200px;
            background:lightBlue; margin:20px 0;
        }
        input[type="text"] {
            display: block;     height: 40px;
            line-height: 40px;  width: 200px;
            text-indent:10px;  margin:10px 0;
            background: #fff;   border-radius: 6px;
            letter-spacing: 1px; font-size: 15px;
        }

    </style>
</head>
<body>
    <div class="container" id="container">
        {{ font }}
        <input type="text" id="a" v-model="font">
    </div>
    <div id="save-fragment"></div>
    <script type="text/javascript">

        window.onload = function () {

            /** Vue ä¸­åŒå‘æ•°æ®ç»‘å®š
             *  http://www.cnblogs.com/kidney/p/6052935.html
             */

            /*
             * subscribe    /sÉ™b'skraÉªb/     vi. è®¢é˜…; è®¢è´­
             * subscriber   /sÉ™bËˆskraÉªbÉ™ /   n. è®¢é˜…è€…; æ¶ˆè´¹; ç”¨æˆ·
             * reactive     /rÉª'Ã¦ktÉªv/       adj. ååº”çš„; èµ·ååº”çš„
             * dependence   /dÉª'pend(É™)ns/   n. ä¾èµ–
             */

            // observer æ£€æŸ¥è€…
            // obj ä¸º Vue æ„é€ å‡½æ•°å†…çš„ this.data, vm ä»£è¡¨æ„é€ å‡½æ•° Vue
            function observe (obj, vm) {
                // Object.keys(): JS-book-learning\ã€Šjsé«˜çº§ç¨‹åºè®¾è®¡ã€‹\jsé«˜ç¨‹éƒ¨åˆ†æ–¹æ³•\jsé«˜ç¨‹---Object.keys().js
                Object.keys(obj).forEach(function (key) {
                    console.log("key: ", key);  // key = font
                    console.log("obj[key]: ", obj[key]); // obj[key] = Hello word!
                    // è°ƒç”¨å“åº”å‡½æ•°
                    defineReactive(vm, key, obj[key]);
                })
            }

            // å“åº”å‡½æ•°: æ³¨æ„: 1st å‚æ•° obj ä¸º Vue æ„é€ å‡½æ•°ï¼› key å¯ä»¥çœ‹å‡ºåˆ†åˆ«æŒ‡ä»£çš„ä¸º data å¯¹è±¡ä¸­çš„é”®å
            function defineReactive (obj, key, val) {

                // é¦–å…ˆå¯¦ä¾‹åŒ–-ä¾è³´å°è±¡ Dependence (å°±æ˜¯å›¾é‡Œçš„: Dep)
                const dep = new Dependence();

                // Object.defineProperty() æ–¹æ³•è®²è§£: è§:
                // JS-book-learning\ã€Šjsé«˜çº§ç¨‹åºè®¾è®¡ã€‹\jsé«˜ç¨‹éƒ¨åˆ†æ–¹æ³•\jsé«˜ç¨‹---Object.defineProperty.html

                // åœ¨ obj (æ³¨: obj ä¸º Vue æ„é€ å‡½æ•°)ä¸Šå®šä¹‰è®¿é—®å™¨å±æ€§ key.
                // æ³¨: è¿™é‡Œçš„å·§å¦™ä¹‹å¤„æ˜¯ä¼šæŠŠ data æ•°æ®ä¸­çš„é”®åæ‹¿æ¥ä½œä¸ºè®¿é—®å™¨å±æ€§çš„å, å¹¶å®šä¹‰åˆ° Vue æ„é€ å‡½æ•°ä¸Š
                // Note(1-0): åˆå§‹åŒ–é¡µé¢ä»£ç æ—¶è¿™ä¸ª defineProperty() æ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨ï¼Œè¢«è°ƒç”¨çš„ä»£ç è§åŒæ³¨é‡Šã€‚
                Object.defineProperty(obj, key, {
                    // getter ä¸­ï¼Œæˆ‘ä»¬æŠŠ watcher æ·»åŠ åˆ° dep ä¸­
                    get: function () {

                        // Dependence.ref æ˜¯åœ¨ Watcher å¯¹è±¡ä¸­å®šä¹‰çš„ï¼ŒæŠŠ Watcher è§‚å¯Ÿè€…èµ‹å€¼ç»™
                        // Dependence å¯¹è±¡çš„ ref å±æ€§ã€‚
                        if (Dependence.ref) {
                            dep.addSub(Dependence.ref)
                        }
                        return val;
                    },
                    // setter ä¸­ï¼Œè§¦å‘ watcher æ‰§è¡Œå›è°ƒ
                    set: function (newVal) {
                        // å½“ Vue() æ„é€ å‡½æ•°å†…çš„ä»£ç æ‰§è¡Œå®Œ(å³:å®Œæ•´çš„è™šæ‹ŸèŠ‚ç‚¹ dom å·²ç»æ’å…¥åˆ° #container ä¸‹),
                        // æˆ‘ä»¬åœ¨ input ä¸­è§¦å‘ keyup äº‹ä»¶æ—¶ï¼Œæµè§ˆå™¨åº”è¯¥ä¼šè‡ªåŠ¨æ‰§è¡Œè¿™é‡Œçš„ set æ–¹æ³•
                        if (newVal === val) return;
                        val = newVal;

                        // ä½œä¸ºå‘å¸ƒè€…å‘å‡ºé€šçŸ¥
                        dep.notify();
                    }
                })
            }

            // è®¢é˜…è€…æ„é€ å‡½æ•°
            function Dependence() {
                // subscriber ç”¨æ¥ä¿å­˜æœ‰å¤šå°‘éœ€è¦å®æ—¶ç›‘å¬çš„: è§‚å¯Ÿè€…(Watcher)
                this.subs = [];
            }
            Dependence.prototype = {
                addSub: function (sub) {
                    this.subs.push(sub);
                },
                notify: function () {
                    this.subs.forEach(function (sub) {
                        // subs æ•°ç»„ä¸­ä¿å­˜çš„æ˜¯æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ª Watcher è§‚å¯Ÿè€…æ„é€ å‡½æ•°
                        sub.update();
                    });
                }
            };


            /* è§‚å¯Ÿè€… Watcher (æ³¨: åœ¨  compile() çš„ç¬¬äºŒä¸ª if è¯­å¥ä¸­è°ƒç”¨)
             * vm(Vue),
             * node(#container ä¸‹çš„ NodeList ä¸­çš„ä¸€ä¸ª),
             * val(åŠ«æŒçš„æ–‡æœ¬èŠ‚ç‚¹çš„å€¼),
             * nodeType(ä¸‹é¢ compiler() ä¼ å…¥çš„ "text")
             * */
            function Watcher (vm, node, val, nodeType) {

                // æŠŠ this èµ‹å€¼ç»™ Dependence.target å¯¹è±¡æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ
                // ç­”: åº”è¯¥æ˜¯æŠŠå½“å‰ Watcher å¯¹è±¡èµ‹å€¼ç»™ Dependence å¯¹è±¡çš„ target å±æ€§ã€‚

                // è¿™é‡Œçš„ target åˆ°åº•æŒ‡ä»€ä¹ˆï¼Œæˆ‘çœŸæ˜¯æ‡µBäº†ä¸€æ•´å¤©,ä¸ºä»€ä¹ˆå‘¢? : åœ¨åŸç”Ÿ js ä¸­æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œtarget ä»£è¡¨äº‹ä»¶å¤„ç†ç¨‹åºçš„
                // çœŸæ­£ç›®æ ‡å³(event.target)ï¼Œæˆ‘å…¨å±€æœç´¢äº†"jsé«˜ç¨‹"ä¸­ target å‡ºç°çš„æ¬¡æ•°ï¼Œé™¤äº†äº‹ä»¶å¯¹è±¡ä¹‹å¤–æ²¡æœ‰åˆ«çš„åœ°æ–¹æœ‰æåŠï¼Œ
                // æ‰€ä»¥æˆ‘åªèƒ½è®¤ä¸ºè¿™é‡Œæ˜¯æŠŠå½“å‰ Watcher å¯¹è±¡èµ‹å€¼ç»™ Dependence å¯¹è±¡çš„ target è‡ªå®šä¹‰å±æ€§ã€‚
                Dependence.ref = this;

                console.log("Watcher æ„é€ å‡½æ•°ä¸­æŸ¥çœ‹æ­¤æ—¶çš„ Dependence: ", Dependence);

                this.val = val;
                this.node = node;
                this.vm = vm;
                this.nodeType = nodeType;

                // æ„é€ å‡½æ•°å†…å°±è°ƒç”¨ update() æ–¹æ³•ï¼Œç»™èŠ‚ç‚¹èµ‹å€¼
                this.update();

                // èµ‹å€¼å®ŒæˆåæŠŠè‡ªå®šä¹‰çš„ Dependence.target è®¾ç½®ä¸º null
                Dependence.ref = null;
            }
            Watcher.prototype = {
                // æ›´æ–°èŠ‚ç‚¹ä¸­çš„æ•°æ®
                update: function () {
                    // é¦–å…ˆå–å¾— Vue ä¸‹ data å±æ€§ä¸­çš„æ•°æ®
                    this.get();

                    // è°ƒç”¨è¿‡ get æ–¹æ³•åæˆ‘ä»¬è¾“å‡ºå½“å‰ Watcher æ„é€ å‡½æ•°æœ‰æ²¡æœ‰ get() æ–¹æ³•ä¸­
                    // æ·»åŠ çš„ this.value å±æ€§
                    console.log("this: ", this);

                    // åˆ¤æ–­å½“å‰èŠ‚ç‚¹ä¸º text èµ°æ­¤åˆ¤æ–­
                    if (this.nodeType === "text") {
                        this.node.nodeValue = this.value;
                    }

                    // åˆ¤æ–­å½“å‰èŠ‚ç‚¹ä¸º input èµ°æ­¤
                    if (this.nodeType === "input") {
                        this.node.value = this.value;
                    }
                },
                // å–å¾—æ•°æ®: æŠŠæ­¤æ—¶ Vue å¯¹è±¡ä¸‹ data å¯¹è±¡ä¸­çš„å±æ€§å€¼èµ‹å€¼ç»™ get æ–¹æ³•å†…æ–°æ·»åŠ çš„ value å±æ€§
                get: function () {
                    // Note(1-1): this.vm[this.val] å°±æ˜¯ç›´æ¥è°ƒç”¨ Object.defineProperty()
                    // ä¸‹çš„ get() æ–¹æ³•ã€‚æ³¨æ„è¿™é‡Œä¹Ÿæ˜¯ defineProperty æ–¹æ³•ç¬¬ä¸€æ¬¡è¢«åˆå§‹åŒ–ã€‚
                    // ğŸ”º this.value ä¸ºå½“å‰æ–¹æ³•å†…åŠ¨æ€ç»™æ„é€ å‡½æ•°æ·»åŠ çš„
                    // ~~Note(1-2): æ³¨æ„è¿™æœ‰ 2 æ¬¡è°ƒç”¨defineProperty()æ–¹æ³•, 1st æ˜¯èŠ‚ç‚¹ä¸º text,~~
                    this.value = this.vm[this.val];
                }
            };


            // èŠ‚ç‚¹è½¬æ¢ä¸ºè™šæ‹Ÿ DOM (node = #container, vm = Vue)
            function nodeToFragment (node, vm) {
                const flag = document.createDocumentFragment();
                let child;

                /* NodeList: { 0:text, 1: input#a, 2: text  }
                 * 0. text: font  1. input#a. 2. text: ä¸ºæ¢è¡Œç¬¦ã€‚
                 * */
                console.log(container.childNodes);

                /* æ­¤å¤„åˆ¤æ–­æ¡ä»¶ä¸ºä»€ä¹ˆæ˜¯ " node.firstChild çš„å€¼èµ‹å€¼ç»™ child " ?
                 * ç­”: (jsé«˜ç¨‹-10.1.1) åœ¨ DOM ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ª childNodes å±æ€§ï¼Œå…¶ä¸­ä¿å­˜ç€ä¸€ä¸ª NodeList å¯¹è±¡ï¼Œ
                 * NodeList å¯¹è±¡ä¼šéšç€ DOM ç»“æ„çš„å˜åŒ–åŠ¨æ€æ›´æ–°ï¼Œå¦‚æœä¿å­˜åœ¨ NodeList ä¸­çš„èŠ‚ç‚¹ä¸º0ï¼Œå†æ¬¡è®¿é—® node.firstChild
                 * æµè§ˆå™¨ä¼šè¿”å›ä¸€ä¸ª nullã€‚åœ¨ while è¯­å¥å†…éƒ¨æ‰¾åˆ°å½“å‰èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹æ¨å…¥åˆ°æ–‡æ¡£å¯¹è±¡æ¨¡å‹ä¸­ï¼Œæ­¤æ—¶æµè§ˆå™¨åŠ¨æ€æŠŠ
                 * ç¬¬äºŒä¸ªå­èŠ‚ç‚¹å˜æ›´ä¸ºç¬¬ä¸€ä¸ªï¼Œ è¿™æ ·å¾ªç¯ç›´åˆ° node.firstChild = null é€€å‡ºå¾ªç¯
                 * */
                while(child = node.firstChild){

                    // ä¼ å…¥ child å’Œ Vue æ¥è§£ææŒ‡ä»¤
                    compile(child, vm);

                    // å°† container ä¸‹æ‰€æœ‰çš„å­èŠ‚ç‚¹åŠ«æŒï¼Œæ”¾åˆ°æ–‡æ¡£ç‰‡æ®µä¸­(æ­¤å¤„æ‰“æ–­ç‚¹å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°è¿‡ç¨‹)
                    flag.appendChild(child);

                    document.getElementById("save-fragment").innerHTML = flag;

                }
                return flag;
            }


            // è§£ææŒ‡ä»¤: node(#container ä¸‹çš„ NodeList ä¸­çš„ä¸€ä¸ª), vm(Vue)
            function compile (node, vm) {

                // . åŒ¹é…ä»»ä½•å­—ç¬¦ï¼Œ * å‰é¢çš„é¡¹å‡ºç°0æ¬¡æˆ–å¤šæ¬¡
                let reg = /\{\{(.*)\}\}/;

                // èŠ‚ç‚¹ç±»å‹ä¸ºå…ƒç´ 
                if (node.nodeType === 1) {
                    let attr = node.attributes;
                    // è§£æå±æ€§
                    for (let i=0; i < attr.length; i++) {
                        if (attr[i].nodeName === "v-model") {
                            // è·å– v-model ç»‘å®šçš„å±æ€§å
                            let name = attr[i].nodeValue;
                            console.log("name: ", name);   // font
                            // å†ç¬¬ä¸€æ¬¡åˆå§‹åŒ–é¡µé¢çš„æ—¶å€™ï¼Œkeyup äº‹ä»¶è¿˜æ²¡æœ‰è°ƒç”¨
                            node.addEventListener("keyup", function (e) {
                                // æŠŠå½“å‰ input ä¸­è¾“å…¥çš„å€¼èµ‹å€¼ç»™ Vue ä¸­å·²å®šä¹‰çš„è®¿é—®å™¨å±æ€§(name: font),
                                // èµ‹å€¼çš„è¿‡ç¨‹å°±æ˜¯è°ƒç”¨ Object.defineProperty() ä¸­çš„ setter æ–¹æ³•ï¼Œ
                                // èµ‹å®Œå€¼ä¹‹åä¼šç«‹å³è°ƒç”¨ Dependence å¯¹è±¡çš„ notify() æ–¹æ³•ï¼Œ notify()
                                // æ–¹æ³•ä¼šéå† subs æ•°ç»„ä¸­ä¿å­˜çš„ Watcher è§‚å¯Ÿè€…å¯¹è±¡ï¼Œç„¶å Watcher
                                // å†…å†è°ƒç”¨ update() æ–¹æ³•
                                vm[name] = e.target.value;
                            });

                            // vm[name]è¿™é‡Œæ˜¯å†æ¬¡è°ƒç”¨äº† Object.defineProperty() ä¸­çš„ get() æ–¹æ³•ï¼Œå–å¾—å€¼
                            // èµ‹å€¼ç»™å½“å‰ input çš„ value å±æ€§
                            node.value = vm[name];
                            node.removeAttribute("v-model");
                        }
                    }
                }
                // èŠ‚ç‚¹ç±»å‹ä¸º text
                if (node.nodeType === 3) {
                    // åˆ©ç”¨æ­£åˆ™åŒ¹é…å½“å‰çš„æ–‡æœ¬èŠ‚ç‚¹
                    if (reg.test(node.nodeValue)) {
                        /* RegExp.$1æ˜¯RegExpçš„ä¸€ä¸ªå±æ€§,æŒ‡çš„æ˜¯ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„ç¬¬ä¸€ä¸ª å­åŒ¹é…(ä»¥æ‹¬å·ä¸ºæ ‡å¿—)
                           å­—ç¬¦ä¸²ï¼Œä»¥æ­¤ç±»æ¨ï¼ŒRegExp.$2ï¼ŒRegExp.$3ï¼Œ..RegExp.$99æ€»å…±å¯ä»¥æœ‰99ä¸ªåŒ¹é… */
                        // è·å–åŒ¹é…åˆ°çš„æ–‡æœ¬èŠ‚ç‚¹çš„å€¼
                        let val = RegExp.$1;
                        val = val.trim();
                        // debugger;
                        console.log("val: ", val);  // val: text(ä¸º font)

                        // å®ä¾‹åŒ–è§‚å¯Ÿè€…æ„é€ å‡½æ•° Watch
                        new Watcher(vm, node, val, "text");
                    }
                }
            }


            function Vue (options) {
                this.data = options.data;
                let data = this.data;

                // 1.å®ä¾‹åŒ– Vue åå–å¾— options.data ä¸­çš„æ‰€æœ‰å±æ€§ï¼Œthis ä¸º Vue æ„é€ å‡½æ•°æœ¬èº«
                observe(data, this);    // ç¬¬ä¸€æ¬¡æ‰§è¡Œä»£ç æ—¶çš„è¾“å‡º data = { font: "Hello world!" }

                // 2.æŠŠ #container ä¸‹çš„èŠ‚ç‚¹åŠ«æŒï¼Œåˆ©ç”¨ nodeToFragment è½¬æ¢ä¸ºè™šæ‹ŸèŠ‚ç‚¹
                let id = options.el;
                let dom = nodeToFragment(document.getElementById(id), this);
                // æœ€åæŠŠå®Œæ•´çš„è™šæ‹ŸèŠ‚ç‚¹ dom å†æ’å…¥åˆ° #container ä¸‹
                document.getElementById(id).appendChild(dom);
            }

            const vm = new Vue({
                el: "container",
                data: {
                    font: "Hello word!"
                }
            })
        }
    </script>
</body>
</html>